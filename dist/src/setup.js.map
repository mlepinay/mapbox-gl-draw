{"version":3,"sources":["../../src/setup.js"],"names":["events","require","Store","ui","Constants","module","exports","ctx","controlContainer","mapLoadedInterval","setup","onRemove","map","off","connect","clearInterval","container","store","parentNode","removeChild","addLayers","addEventListeners","onAdd","getContainer","addButtons","options","boxSelect","boxZoom","disable","dragPan","enable","loaded","on","setInterval","start","addSource","sources","COLD","data","type","geojsonTypes","FEATURE_COLLECTION","features","HOT","styles","forEach","addLayer","style","render","removeLayers","getLayer","id","removeLayer","getSource","removeSource"],"mappings":"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","file":"setup.js","sourcesContent":["const events = require('./events');\nconst Store = require('./store');\nconst ui = require('./ui');\nconst Constants = require('./constants');\n\nmodule.exports = function(ctx) {\n\n  let controlContainer = null;\n  let mapLoadedInterval = null;\n\n  const setup = {\n    onRemove: function() {\n      // Stop connect attempt in the event that control is removed before map is loaded\n      ctx.map.off('load', setup.connect);\n      clearInterval(mapLoadedInterval);\n\n      // setup.removeLayers();\n      // ctx.ui.removeButtons();\n      // ctx.events.removeEventListeners();\n      ctx.map = null;\n      ctx.container = null;\n      ctx.store = null;\n\n      if (controlContainer && controlContainer.parentNode) controlContainer.parentNode.removeChild(controlContainer);\n      controlContainer = null;\n\n      return this;\n    },\n    connect: function() {\n      ctx.map.off('load', setup.connect);\n      clearInterval(mapLoadedInterval);\n      setup.addLayers();\n      ctx.events.addEventListeners();\n    },\n    onAdd: function(map) {\n      ctx.map = map;\n      ctx.events = events(ctx);\n      ctx.ui = ui(ctx);\n      ctx.container = map.getContainer();\n      ctx.store = new Store(ctx);\n\n      controlContainer = ctx.ui.addButtons();\n\n      if (ctx.options.boxSelect) {\n        map.boxZoom.disable();\n        // Need to toggle dragPan on and off or else first\n        // dragPan disable attempt in simple_select doesn't work\n        map.dragPan.disable();\n        map.dragPan.enable();\n      }\n\n      if (map.loaded()) {\n        setup.connect();\n      } else {\n        map.on('load', setup.connect);\n        mapLoadedInterval = setInterval(() => { if (map.loaded()) setup.connect(); }, 16);\n      }\n\n      ctx.events.start();\n      return controlContainer;\n    },\n    addLayers: function() {\n      // drawn features style\n      ctx.map.addSource(Constants.sources.COLD, {\n        data: {\n          type: Constants.geojsonTypes.FEATURE_COLLECTION,\n          features: []\n        },\n        type: 'geojson'\n      });\n\n      // hot features style\n      ctx.map.addSource(Constants.sources.HOT, {\n        data: {\n          type: Constants.geojsonTypes.FEATURE_COLLECTION,\n          features: []\n        },\n        type: 'geojson'\n      });\n\n      ctx.options.styles.forEach(style => {\n        ctx.map.addLayer(style);\n      });\n\n      ctx.store.render();\n    },\n    // Check for layers and sources before attempting to remove\n    // If user adds draw control and removes it before the map is loaded, layers and sources will be missing\n    removeLayers: function() {\n      ctx.options.styles.forEach(style => {\n        if (ctx.map.getLayer(style.id)) {\n          ctx.map.removeLayer(style.id);\n        }\n      });\n\n      if (ctx.map.getSource(Constants.sources.COLD)) {\n        ctx.map.removeSource(Constants.sources.COLD);\n      }\n\n      if (ctx.map.getSource(Constants.sources.HOT)) {\n        ctx.map.removeSource(Constants.sources.HOT);\n      }\n    }\n  };\n\n  ctx.setup = setup;\n\n  return setup;\n};"]}